name: Build Mac DMG

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Create icon placeholder
        run: |
          mkdir -p assets
          if [ ! -f assets/icon.icns ]; then
            cp /System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/GenericApplicationIcon.icns assets/icon.icns 2>/dev/null || echo "Icon placeholder skipped"
          fi

      - name: Build Mac (arm64 zip + x64 DMG)
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Make fix script executable
        run: chmod +x Fix-Fractal-AI-Builder.command

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Fractal-AI-Builder
          path: |
            dist/*.dmg
            dist/*.zip
            Fix-Fractal-AI-Builder.command
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v${{ github.run_number }}
          name: "Fractal AI Builder v${{ github.run_number }}"
          body: |
            ## Fractal AI Builder

            AI-powered preset builder for Fractal Audio FM3-Edit, Axe-Edit III, and AM4.

            ---

            ### Download

            | Mac Type | File to Download |
            |---|---|
            | **Apple Silicon (M1/M2/M3/M4/M5)** | `Fractal.AI.Builder-1.0.0-arm64-mac.zip` |
            | **Intel Mac** | `Fractal.AI.Builder-1.0.0.dmg` |

            ---

            ### Install (Apple Silicon — ZIP file)

            1. Download `Fractal.AI.Builder-1.0.0-arm64-mac.zip`
            2. Double-click it — a **Fractal AI Builder.app** file appears
            3. Drag **Fractal AI Builder.app** into your **Applications** folder
            4. Download **`Fix-Fractal-AI-Builder.command`** from the files below
            5. Double-click the `.command` file → enter your Mac password → app launches ✅

            ### Install (Intel Mac — DMG file)

            1. Download `Fractal.AI.Builder-1.0.0.dmg`
            2. Open it and drag the app to **Applications**
            3. Download and run **`Fix-Fractal-AI-Builder.command`** the first time

            ---

            ### Setup
            1. Enter your Anthropic API key in the left settings panel
            2. Open FM3-Edit, Axe-Edit III, or AM4 Edit on your Mac
            3. Describe your preset → click **Start AI Session**
          files: |
            dist/*.dmg
            dist/*.zip
            Fix-Fractal-AI-Builder.command
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
