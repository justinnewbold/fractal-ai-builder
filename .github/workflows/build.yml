name: Build Mac DMG

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Create icon placeholder
        run: |
          mkdir -p assets
          if [ ! -f assets/icon.icns ]; then
            cp /System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/GenericApplicationIcon.icns assets/icon.icns 2>/dev/null || echo "Icon placeholder skipped"
          fi

      - name: Build Mac DMG (arm64 + x64)
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Make fix script executable
        run: chmod +x Fix-Fractal-AI-Builder.command

      - name: Upload DMG artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Fractal-AI-Builder-DMG
          path: |
            dist/*.dmg
            Fix-Fractal-AI-Builder.command
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v${{ github.run_number }}
          name: "Fractal AI Builder v${{ github.run_number }}"
          body: |
            ## Fractal AI Builder

            AI-powered preset builder for Fractal Audio FM3-Edit, Axe-Edit III, and AM4.

            ---

            ### Download

            | Mac Type | File |
            |---|---|
            | **Apple Silicon (M1–M5)** | `Fractal.AI.Builder-1.0.0-arm64.dmg` |
            | **Intel Mac** | `Fractal.AI.Builder-1.0.0.dmg` |

            ---

            ### Fix the "Damaged" Warning

            macOS blocks unsigned apps downloaded from the internet. Fix it in 3 steps:

            1. Open the `.dmg` and drag the app to **Applications**
            2. Download **`Fix-Fractal-AI-Builder.command`** (below)
            3. Double-click it → enter your Mac password → done ✅

            You only need to do this once.

            ---

            ### Setup
            1. Enter your Anthropic API key in the settings panel
            2. Open FM3-Edit or Axe-Edit III
            3. Describe your preset → **Start AI Session**
          files: |
            dist/*.dmg
            Fix-Fractal-AI-Builder.command
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
